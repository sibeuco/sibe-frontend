<div class="attendance-record-container">

  <!-- Botón para iniciar la actividad -->
  <div class="start-activity-section mb-4" *ngIf="!actividadIniciada">
    <div class="alert text-center">
      <i class="bi bi-info-circle me-2"></i>
      <h4>La actividad no está iniciada</h4>
      <p class="mb-0">Para tomar la asistencia de los participantes, debes iniciar la actividad.</p>
    </div>
    <div class="start-activity-btn-container">
      <button
        type="button"
        class="btn start-activity-btn"
        (click)="iniciarActividad()"
        [disabled]="iniciandoActividad || !ejecucionSeleccionadaId">
        {{ iniciandoActividad ? 'Iniciando...' : 'Iniciar Actividad' }}
      </button>
    </div>
  </div>

  <!-- Formulario de búsqueda - Se muestra después de iniciar la actividad -->
  <div class="search-section" *ngIf="actividadIniciada">
    <div class="search-form">
      <div class="row">
        <div class="col-md-5 mb-3">
          <label for="rfid" class="form-label">Código RFID</label>
          <input type="text" class="form-control" id="rfid" [(ngModel)]="rfidSearch"
            placeholder="Ingrese el código RFID del carnet" (keyup.enter)="buscarParticipante()">
        </div>
        <div class="col-md-5 mb-3">
          <label for="documento" class="form-label">Documento</label>
          <input type="text" class="form-control" id="documento" [(ngModel)]="documentoSearch"
            placeholder="Ingrese el número de documento" (keyup.enter)="buscarParticipante()">
        </div>
        <div class="search-button-container col-md-2 mb-3">
          <button type="button" class="btn btn-primary search-btn" (click)="buscarParticipante()"
            [disabled]="!rfidSearch && !documentoSearch || buscando">
            <i class="bi bi-search" *ngIf="!buscando"></i>
            <span class="spinner-border spinner-border-sm" *ngIf="buscando"></span>
            {{ buscando ? 'Buscando...' : 'Buscar' }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Mensajes de estado -->
  <div class="alert-section" *ngIf="mensaje">
    <div class="alert" [ngClass]="{
      'alert-success': tipoMensaje === 'success',
      'alert-danger': tipoMensaje === 'error',
      'alert-warning': tipoMensaje === 'warning'
    }">
      {{ mensaje }}
    </div>
  </div>

  <!-- Tabla de participantes -->
  <div class="participants-section" *ngIf="actividadIniciada && miembrosAsistencia.length > 0">
    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead class="table-dark">
          <tr>
            <th>Nombre Completo</th>
            <th>Documento</th>
            <th>Programa Académico</th>
            <th>Correo Institucional</th>
            <th>Tipo</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let participante of miembrosAsistencia; let i = index">
            <td>{{ participante.nombreCompleto }}</td>
            <td>{{ participante.documentoIdentificacion }}</td>
            <td>{{ participante.programaAcademico || 'N/A' }}</td>
            <td>{{ participante.correoInstitucional || 'N/A' }}</td>
            <td>{{ participante.tipo || 'N/A' }}</td>
            <td>
              <button type="button" class="btn btn-sm btn-outline-danger" (click)="removerParticipante(i)"
                title="Remover participante">
                <i class="bi bi-trash"></i>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="participants-count">
      <span class="badge ">Total: {{ miembrosAsistencia.length }} participantes</span>
    </div>
  </div>

  <!-- Mensaje cuando no hay participantes registrados aún -->
  <div class="no-participants-section" *ngIf="actividadIniciada && miembrosAsistencia.length === 0">
    <div class="alert text-center">
      <i class="bi bi-info-circle me-2"></i>
      <h4>No hay participantes registrados</h4>
      <p class="mb-0">Registra participantes utilizando el formulario superior.</p>
    </div>
  </div>

  <!-- Botones de acción -->
  <div class="action-buttons-section" *ngIf="actividadIniciada">
    <div class="row">
      <div class="cancel-button-container col-md-6 mb-2">
        <button
          type="button"
          class="btn btn-secondary"
          (click)="cancelarActividad()"
          [disabled]="guardando || cancelandoActividad">
          {{ cancelandoActividad ? 'Cancelando...' : 'Cancelar' }}
        </button>
      </div>
      <div class="success-bottom-container col-md-6 mb-2">
        <button type="button" class="btn btn-success" (click)="finalizarActividad()"
          [disabled]="miembrosAsistencia.length === 0 || guardando">
          <i *ngIf="!guardando"></i>
          <span class="spinner-border spinner-border-sm" *ngIf="guardando"></span>
          {{ guardando ? 'Guardando...' : 'Finalizar Actividad' }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de confirmación para participante externo -->
<div class="modal-container modal fade" id="confirmExternalParticipantModal" tabindex="-1"
  aria-labelledby="confirmExternalParticipantModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header col d-flex align-items-center justify-content-center position-relative">
        <h1 class="modal-title" id="confirmExternalParticipantModalLabel">
          <i class="bi bi-question-circle-fill me-2"></i>
          Participante No Encontrado
        </h1>
        <button type="button" class="btn-close position-absolute" (click)="cancelarAgregarParticipanteExterno()"
          aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex align-items-center justify-content-center mb-4">
          <div class="text-center">
            <i class="bi bi-person-plus text-warning" style="font-size: 4rem;"></i>
            <p class="mt-3 mb-1" style="font-size: 1.8rem;">No se encontró ningún participante con los datos ingresados.
            </p>
            <p class="mb-1" style="font-size: 1.6rem;">¿Deseas agregar este participante como participante externo?</p>
          </div>
        </div>
      </div>
      <div class="modal-footer d-flex justify-content-center">
        <button type="button" class="cancel-button btn btn-secondary me-3"
          (click)="cancelarAgregarParticipanteExterno()">
          <i class="bi bi-x-circle me-1"></i>
          Cancelar
        </button>
        <button type="button" class="confirm-button btn btn-primary" (click)="confirmarAgregarParticipanteExterno()">
          <i class="bi bi-person-plus me-1"></i>
          Agregar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de participante externo -->
<app-external-participant (participanteAgregado)="manejarParticipanteExterno($event)"></app-external-participant>